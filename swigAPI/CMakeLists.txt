
LINK_DIRECTORIES(
 ${VISHNU_EXCEPTION_INCLUDE_DIR}
)

INCLUDE_DIRECTORIES(
  ${API_SOURCE_DIR}
  ${DIET_INCLUDE_DIR}
  ${EMF_DATA_DIR}
  ${UMS_DATA_DIR}
  ${EMF4CPP_INCLUDE_DIR}
  ${VISHNU_EXCEPTION_INCLUDE_DIR}
  ${CLIENT_PROXY_SOURCE_DIR}
  ${UTILVISHNU_SOURCE_DIR}
  ${Boost_INCLUDE_DIRS}
  ${TMS_API_SOURCE_DIR}
  ${IMS_API_SOURCE_DIR}
  ${FMS_API_SOURCE_DIR}
  ${TMS_EMF_DATA_DIR}
  ${TMS_DATA_DIR}
  ${IMS_UTIL_DIR}
  ${TMS_CLIENT_PROXY_SOURCE_DIR}
  ${IMS_EMF_DATA_DIR}
  ${IMS_DATA_DIR}
  ${IMS_CLIENT_PROXY_SOURCE_DIR}
  ${FMS_EMF_DATA_DIR}
  ${FMS_DATA_DIR}
  ${FMS_CLIENT_PROXY_SOURCE_DIR}
)

# Java and/or python are options
if (ENABLE_PYTHON OR ENABLE_JAVA)

IF(NOT ENABLE_SWIG AND NOT COMPILE_ALL_MODULES)
  MESSAGE(FATAL_ERROR "If all VISHNU modules are not compiled together, SWIG is required to regenerate the Python and Java wrappers code. Please set the option ENABLE_SWIG to ON or compile all VISHNU modules.")
ENDIF(NOT ENABLE_SWIG AND NOT COMPILE_ALL_MODULES)

IF(ENABLE_SWIG)
  FIND_PACKAGE(SWIG 1.3.40 REQUIRED)
  INCLUDE(${SWIG_USE_FILE})
  MARK_AS_ADVANCED(SWIG_DIR)
  MARK_AS_ADVANCED(SWIG_EXECUTABLE)
  MARK_AS_ADVANCED(SWIG_VERSION)

  # General SWIG configuration
  SET_SOURCE_FILES_PROPERTIES(vishnu.i PROPERTIES CPLUSPLUS ON)

  #Suppress warnings about ignored operators (out_ptr::operator= and EList::operator[])
  SET(CMAKE_SWIG_FLAGS "-w362,389")
ENDIF(ENABLE_SWIG)

#Install swig language-specific generated files in a dedicated directory
SET (CMAKE_SWIG_OUTDIR ${CMAKE_CURRENT_BINARY_DIR}/swig_output)
FILE(MAKE_DIRECTORY ${CMAKE_SWIG_OUTDIR})

if(ENABLE_PYTHON)
  FIND_PACKAGE(PythonLibs REQUIRED)
  INCLUDE_DIRECTORIES(${PYTHON_INCLUDE_PATH})
endif(ENABLE_PYTHON)

IF(ENABLE_JAVA)
  FIND_PACKAGE(Java REQUIRED)
  FIND_PATH(JAVA_INCLUDE_DIR jni.h
    $ENV{JAVA_HOME}/include
    /usr/lib/jvm/java/include
    /usr/lib/jvm/java-6*/include
    /usr/lib/jvm/java-6-sun-1.6.0.22/include
  )
  INCLUDE_DIRECTORIES(
    ${JAVA_INCLUDE_DIR}
    ${JAVA_INCLUDE_DIR}/linux
  )
ENDIF(ENABLE_JAVA)


add_definitions(-DCOMPILE_UMS)
set(CMAKE_SWIG_FLAGS ${CMAKE_SWIG_FLAGS} "-DCOMPILE_UMS" )

set (SWIG_LINK_LIB
  ${SWIG_LINK_LIB}
  emf4cpp-UMS_Data
  emf4cpp-TMS_Data
  emf4cpp-FMS_Data
  emf4cpp-IMS_Data
  vishnu-ums-api
  exception-vishnu 
  ${DIET_CLIENT_LIB} )

if(COMPILE_TMS)
  add_definitions(-DCOMPILE_TMS)
  set( CMAKE_SWIG_FLAGS ${CMAKE_SWIG_FLAGS} "-DCOMPILE_TMS" )
  set (SWIG_LINK_LIB
    ${SWIG_LINK_LIB}
    vishnu-tms-api
    )
endif()
if(COMPILE_IMS)
  add_definitions(-DCOMPILE_IMS)
  set( CMAKE_SWIG_FLAGS ${CMAKE_SWIG_FLAGS} "-DCOMPILE_IMS" )
  set (SWIG_LINK_LIB
    ${SWIG_LINK_LIB}
    vishnu-ims-api
    )
endif()
if(COMPILE_FMS)
  set( CMAKE_SWIG_FLAGS ${CMAKE_SWIG_FLAGS} "-DCOMPILE_FMS" )
  add_definitions(-DCOMPILE_FMS)
  set (SWIG_LINK_LIB
    ${SWIG_LINK_LIB}
    vishnu-fms-api
    )
endif()


if(ENABLE_SWIG)
  ## PYTHON MODULE
  #The module name must match the %module declaration in the interface file
  if(ENABLE_PYTHON)
    SWIG_ADD_MODULE(VISHNU python vishnu.i)
    SET_TARGET_PROPERTIES(${SWIG_MODULE_VISHNU_REAL_NAME} PROPERTIES COMPILE_FLAGS "-fPIC")
    SWIG_LINK_LIBRARIES(VISHNU ${PYTHON_LIBRARIES} ${SWIG_LINK_LIB})

    INSTALL( TARGETS ${SWIG_MODULE_VISHNU_REAL_NAME} DESTINATION lib )
  ENDIF(ENABLE_PYTHON)

  ## JAVA MODULE
  IF(ENABLE_JAVA)
    SET(CMAKE_SWIG_FLAGS ${CMAKE_SWIG_FLAGS} "-w503" "-package" "com.sysfera.vishnu.api.vishnu.internal")
    SWIG_ADD_MODULE(VISHNU java vishnu.i)
    SET_TARGET_PROPERTIES(${SWIG_MODULE_VISHNU_REAL_NAME} PROPERTIES COMPILE_FLAGS "-fPIC")
    SWIG_LINK_LIBRARIES(VISHNU ${JAVA_LIBRARIES} ${SWIG_LINK_LIB})

    INSTALL( TARGETS ${SWIG_MODULE_VISHNU_REAL_NAME} DESTINATION lib)
  ENDIF(ENABLE_JAVA)

  INSTALL( DIRECTORY ${CMAKE_SWIG_OUTDIR} DESTINATION lib)

else(ENABLE_SWIG)
# Use pre-generated wrappers
  IF(ENABLE_JAVA)
    ADD_LIBRARY(VISHNU generated/vishnuJAVA_wrap.cxx)
    SET_TARGET_PROPERTIES(VISHNU PROPERTIES COMPILE_FLAGS "-fPIC")
    TARGET_LINK_LIBRARIES(VISHNU ${JAVA_LIBRARIES} ${SWIG_LINK_LIB})

    INSTALL(TARGETS VISHNU DESTINATION lib)
    FILE(GLOB JAVAFILES "${CMAKE_CURRENT_SOURCE_DIR}/generated/swig_output/*.java")
    FOREACH(javafile ${JAVAFILES})
      INSTALL(FILES ${javafile} DESTINATION lib/swig_output)
    ENDFOREACH(javafile)
  ENDIF(ENABLE_JAVA)
  
  IF (ENABLE_PYTHON)
    ADD_LIBRARY(_VISHNU generated/vishnuPYTHON_wrap.cxx)
    SET_TARGET_PROPERTIES(_VISHNU PROPERTIES COMPILE_FLAGS "-fPIC")
    SET_TARGET_PROPERTIES(_VISHNU PROPERTIES PREFIX "")
    TARGET_LINK_LIBRARIES(_VISHNU ${PYTHON_LIBRARIES} ${SWIG_LINK_LIB})

    INSTALL(TARGETS _VISHNU DESTINATION lib RENAME _VISHNU.so)
    INSTALL(FILES generated/swig_output/VISHNU.py DESTINATION lib/swig_output)
  ENDIF(ENABLE_PYTHON)

endif(ENABLE_SWIG)

endif(ENABLE_PYTHON OR ENABLE_JAVA)

